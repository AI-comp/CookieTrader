<!doctype html>
<html role="application">
<meta charset=utf-8>
<title>Cookie Trader</title>
<link rel="stylesheet" href="css/style.css">
<body>
<div id="wrapper" class="l-h-flex">
<header>
  <h1>Cookie Trader</h1>
</header>
<main class="l-flex-item l-v-flex">
  <div class="l-flex-item l-h-flex">
    <div id="info-block" class="l-flex-item">
      You have <span id="my-total-cookie">0</span> cookies.<br>
      You bake <span id="my-cps">0.0</span> cookies per seconds.
    </div>
    <div id="type-block">
      <p>Typing here.
    </div>
  </div>
  <div id="action-block">
    <div>
    </div>
    <div class="bakeries">
      <div id="bakery-Cursor" class="bakery-item">Pointer</div>
      <div id="bakery-Grandma" class="bakery-item">Grandma</div>
      <div id="bakery-Farm" class="bakery-item">Farm</div>
      <div id="bakery-Factory" class="bakery-item">Factory</div>
      <div id="bakery-Mine" class="bakery-item">Mine</div>
      <div id="bakery-Shipment" class="bakery-item">Shipment</div>
      <div id="bakery-AlchemyLab" class="bakery-item">AlchemyLab</div>
      <div id="bakery-Portal" class="bakery-item">Portal</div>
      <div id="bakery-TimeMachine" class="bakery-item">Time Machine</div>
      <div id="bakery-AntimatterCondenser" class="bakery-item">Antimatter Condenser</div>
    </div>
  </div>
</main>
<footer>
  This application inspires to <a href="http://orteil.dashnet.org/cookieclicker/">Cookie Clicker</a>
</footer>
</div><!-- /wrapper -->
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="/socket.io/socket.io.js" type="text/javascript"></script>
<script src="/js/game.js" type="text/javascript"></script>
<script>
$(function() {

  var pretty = function (val) {
    return '' + Math.floor(val);
  };

  var FPS = 10;

  var player = new Player(0, 10);
  player.hook('totalCookie', function (v) {
    $('#my-total-cookie').text(pretty(player.totalCookie));
  });
  player.hook('currentCps', function (v) {
    $('#my-cps').text(v);
  });
  player.totalCookie = 1000;
  player.currentCps = 0;

  // WebSocketサーバに接続
  var socket = io.connect('http://localhost:5000/');

  socket.on('connect', function(){
    console.log('connect!')
  });

  socket.on('disconnect', function(){
    console.log("disconnect from server");
  });

  // メッセージ受信イベントを処理
  socket.on('message', function(msg) {
    console.log('Received : ' + msg);
  });

  socket.on('buy', function (obj) {
    var status = obj.status;
    if (status === 'ok') {
      var bakeryName = obj.bakeryName,
          price = parseInt(obj.price, 10);
      player.buy(bakeryName, price);
    } else {
      // TODO
    }
  });

  $(document).keydown(function (e) {
    if (e.keyCode === 32 || e.keyCode === 13) {
      player.clickCookie();
    }
  });

  $('.bakery-item').click(function (e) {
    var id = e.target.id;
    id.match(/bakery-(.+)/);
    var bakeryName = RegExp.$1;
    socket.emit('buy', { 'bakery': bakeryName, 'totalCookie': player.totalCookie })
  });

  var prevTime = new Date().getTime();
  var loop = function() {
    var curTime = new Date().getTime();

    player.bake((curTime - prevTime) / 1000);

    prevTime = curTime;
    setTimeout(loop, 1000 / FPS);
  };
  loop();

});
</script>
